/**
 * GESTOR DE RESERVAS - BookingManager
 * 
 * Esta clase maneja todo el sistema de reservas de citas, incluyendo:
 * - ValidaciÃ³n de formularios
 * - EnvÃ­o de emails automÃ¡ticos
 * - GestiÃ³n de campos condicionales
 * - Control de modales y notificaciones
 * - Almacenamiento local de respaldo
 */

class BookingManager {
    /**
     * CONSTRUCTOR - Inicializa la configuraciÃ³n del gestor
     * Establece los parÃ¡metros de EmailJS y ejecuta la inicializaciÃ³n
     */
    constructor() {
        // ConfiguraciÃ³n de EmailJS para envÃ­o de emails automÃ¡ticos
        this.emailConfig = {
            serviceId: 'service_xsakmyn',        // ID del servicio de email
            templateId: 'template_1dt15su',      // ID de la plantilla HTML del email
            publicKey: 'vdWmzVZ71cnknMJPF'      // Clave pÃºblica para autenticaciÃ³n
        };
        
        this.isInitialized = false;  // Control de estado de inicializaciÃ³n
        this.init();                 // Ejecutar inicializaciÃ³n automÃ¡tica
    }

    /**
     * INICIALIZACIÃ“N PRINCIPAL
     * Configura todos los componentes del sistema de reservas
     */
    async init() {
        try {
            // Configurar el formulario principal y sus eventos
            await this.setupForm();
            
            // Configurar validaciÃ³n de fechas (no permitir fechas pasadas)
            this.setupDateValidation();
            
            // Configurar campos que aparecen/desaparecen segÃºn selecciones
            this.setupConditionalFields();
            
            // Configurar ventana modal de Ã©xito
            this.setupModal();
            
            // Cargar y configurar EmailJS para envÃ­o de emails
            await this.loadEmailJS();
            
            this.isInitialized = true;
            console.log('âœ… BookingManager initialized successfully');
        } catch (error) {
            console.error('âŒ Error initializing BookingManager:', error);
        }
    }

    /**
     * CARGA DE EMAILJS
     * Carga dinÃ¡micamente la librerÃ­a EmailJS desde CDN
     * Incluye manejo de timeouts y errores
     */
    async loadEmailJS() {
        return new Promise((resolve, reject) => {
            // Si EmailJS ya estÃ¡ cargado, no hacer nada
            if (window.emailjs) {
                resolve();
                return;
            }

            // Crear script tag para cargar EmailJS
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js';
            
            // Timeout de seguridad (10 segundos mÃ¡ximo)
            const timeout = setTimeout(() => {
                script.remove();
                reject(new Error('EmailJS load timeout'));
            }, 10000);

            // Cuando el script se carga exitosamente
            script.onload = () => {
                clearTimeout(timeout);
                try {
                    // Inicializar EmailJS con la clave pÃºblica
                    emailjs.init(this.emailConfig.publicKey);
                    console.log('âœ… EmailJS loaded and initialized');
                    resolve();
                } catch (error) {
                    reject(error);
                }
            };
            
            // Si hay error cargando el script
            script.onerror = () => {
                clearTimeout(timeout);
                script.remove();
                reject(new Error('Failed to load EmailJS'));
            };
            
            // AÃ±adir el script al documento
            document.head.appendChild(script);
        });
    }

    /**
     * CONFIGURACIÃ“N DEL FORMULARIO
     * Establece eventos para envÃ­o y reset del formulario
     */
    setupForm() {
        const form = document.getElementById('bookingForm');
        if (!form) {
            console.warn('Booking form not found');
            return;
        }

        // Evento para manejar el envÃ­o del formulario
        form.addEventListener('submit', (e) => {
            e.preventDefault();           // Prevenir envÃ­o normal del formulario
            this.handleSubmit(form);      // Manejar envÃ­o personalizado
        });

        // Configurar botÃ³n de reset/limpiar
        const resetBtn = document.getElementById('resetBtn');
        if (resetBtn) {
            resetBtn.addEventListener('click', () => {
                form.reset();                    // Limpiar todos los campos
                this.hideAddressSection();      // Ocultar secciÃ³n de direcciÃ³n
            });
        }
    }

    /**
     * VALIDACIÃ“N DE FECHAS
     * Establece fechas mÃ­nimas y mÃ¡ximas permitidas para reservas
     */
    setupDateValidation() {
        const dateInput = document.getElementById('date');
        if (dateInput) {
            // Fecha mÃ­nima: hoy (no permitir fechas pasadas)
            const today = new Date().toISOString().split('T')[0];
            dateInput.min = today;
            
            // Fecha mÃ¡xima: 3 meses desde hoy
            const maxDate = new Date();
            maxDate.setMonth(maxDate.getMonth() + 3);
            dateInput.max = maxDate.toISOString().split('T')[0];
        }
    }

    /**
     * CONFIGURACIÃ“N DE CAMPOS CONDICIONALES
     * Maneja la apariciÃ³n/desapariciÃ³n de campos segÃºn selecciones del usuario
     */
    setupConditionalFields() {
        const pickupCheckbox = document.getElementById('pickup');
        const addressSection = document.getElementById('addressSection');

        if (pickupCheckbox && addressSection) {
            // Cuando cambia el estado del checkbox de recolecciÃ³n
            pickupCheckbox.addEventListener('change', () => {
                if (pickupCheckbox.checked) {
                    this.showAddressSection();    // Mostrar campo de direcciÃ³n
                } else {
                    this.hideAddressSection();    // Ocultar campo de direcciÃ³n
                }
            });
        }
    }

    /**
     * MOSTRAR SECCIÃ“N DE DIRECCIÃ“N
     * Hace visible el campo de direcciÃ³n y lo marca como requerido
     */
    showAddressSection() {
        const addressSection = document.getElementById('addressSection');
        const addressInput = document.getElementById('address');
        
        if (addressSection && addressInput) {
            addressSection.classList.remove('hidden');  // Mostrar visualmente
            addressInput.required = true;               // Marcar como campo obligatorio
        }
    }

    /**
     * OCULTAR SECCIÃ“N DE DIRECCIÃ“N
     * Oculta el campo de direcciÃ³n y lo marca como no requerido
     */
    hideAddressSection() {
        const addressSection = document.getElementById('addressSection');
        const addressInput = document.getElementById('address');
        
        if (addressSection && addressInput) {
            addressSection.classList.add('hidden');     // Ocultar visualmente
            addressInput.required = false;              // Marcar como no obligatorio
            addressInput.value = '';                    // Limpiar el valor
        }
    }

    /**
     * CONFIGURACIÃ“N DE MODAL
     * Establece eventos para mostrar/ocultar ventana modal de Ã©xito
     */
    setupModal() {
        const modal = document.getElementById('successModal');
        const closeBtn = document.getElementById('closeModal');

        if (closeBtn && modal) {
            // Cerrar modal con botÃ³n X
            closeBtn.addEventListener('click', () => {
                this.hideModal();
            });

            // Cerrar modal haciendo click fuera de Ã©l
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    this.hideModal();
                }
            });
        }
    }

    /**
     * MOSTRAR MODAL DE Ã‰XITO
     * Muestra la ventana modal y bloquea scroll del body
     */
    showModal() {
        const modal = document.getElementById('successModal');
        if (modal) {
            modal.classList.remove('hidden');          // Hacer visible
            document.body.style.overflow = 'hidden';   // Bloquear scroll de fondo
        }
    }

    /**
     * OCULTAR MODAL
     * Oculta la ventana modal y restaura scroll del body
     */
    hideModal() {
        const modal = document.getElementById('successModal');
        if (modal) {
            modal.classList.add('hidden');             // Ocultar
            document.body.style.overflow = '';         // Restaurar scroll
        }
    }

    /**
     * MANEJO DE ENVÃO DEL FORMULARIO
     * Procesa el envÃ­o completo: validaciÃ³n, email y confirmaciÃ³n
     */
    async handleSubmit(form) {
        // Verificar que el sistema estÃ© inicializado
        if (!this.isInitialized) {
            console.warn('BookingManager not initialized yet');
            this.showErrorNotification('Sistema no inicializado. Por favor recarga la pÃ¡gina.');
            return;
        }

        try {
            // Mostrar estado de carga en el botÃ³n
            this.setLoadingState(true);

            // Extraer datos del formulario
            const formData = new FormData(form);
            const bookingData = Object.fromEntries(formData.entries());

            // Validar que todos los campos requeridos estÃ©n completos
            if (!this.validateForm(bookingData)) {
                throw new Error('Por favor completa todos los campos requeridos');
            }

            console.log('ðŸ“§ Enviando email con datos:', bookingData);

            // Enviar email de reserva al negocio
            await this.sendBookingEmail(bookingData);

            // Guardar reserva en almacenamiento local (respaldo)
            this.saveBooking(bookingData);

            // Mostrar confirmaciÃ³n de Ã©xito
            this.showModal();
            form.reset();                    // Limpiar formulario
            this.hideAddressSection();      // Ocultar campos condicionales

            this.showSuccessNotification('Â¡Reserva enviada exitosamente! RecibirÃ¡s confirmaciÃ³n pronto.');

        } catch (error) {
            console.error('âŒ Error enviando reserva:', error);
            this.showErrorNotification('Error al enviar la reserva. Por favor intenta nuevamente o contacta por telÃ©fono.');
        } finally {
            // Restaurar estado normal del botÃ³n
            this.setLoadingState(false);
        }
    }

    /**
     * ENVÃO DE EMAIL DE RESERVA
     * Utiliza EmailJS para enviar la informaciÃ³n de la reserva por email
     */
    async sendBookingEmail(data) {
        // Verificar que EmailJS estÃ© disponible
        if (!window.emailjs) {
            throw new Error('EmailJS no estÃ¡ disponible');
        }

        // Mapeo de cÃ³digos de servicios a nombres legibles en espaÃ±ol
        const serviceNames = {
            'alteraciones-basicas': 'Alteraciones BÃ¡sicas ($25-50)',
            'reparaciones': 'Reparaciones ($15-35)', 
            'ajustes-formales': 'Ajustes Formales ($40-80)',
            'vestidos-novia': 'Vestidos de Novia ($150-300)',
            'diseno-personalizado': 'DiseÃ±o Personalizado (CotizaciÃ³n)'
        };

        // Obtener nombre legible del servicio
        const serviceName = serviceNames[data.service] || data.service;

        // Preparar parÃ¡metros que coinciden con la plantilla de EmailJS
        const templateParams = {
            // InformaciÃ³n personal del cliente
            from_name: `${data.firstName} ${data.lastName}`,
            from_email: data.email,
            phone: data.phone,
            
            // Detalles del servicio
            service: serviceName,
            date: this.formatDate(data.date),
            time: this.formatTime(data.time),
            
            // Opciones adicionales
            priority: data.priority ? 'SÃ­' : 'No',          // Servicio express
            pickup: data.pickup ? 'SÃ­' : 'No',              // RecolecciÃ³n a domicilio
            address: data.address || '',                     // DirecciÃ³n (si aplica)
            description: data.description || '',             // DescripciÃ³n adicional
            
            // Metadatos del email
            to_email: 'info@margaritastailoring.com',        // Email del negocio
            subject: `Nueva Reserva - ${data.firstName} ${data.lastName}`,
            
            // Mensaje completo como respaldo
            message: this.createFullMessage(data, serviceName)
        };

        console.log('ðŸ“§ ParÃ¡metros del email:', templateParams);

        try {
            // Enviar email usando EmailJS
            const result = await emailjs.send(
                this.emailConfig.serviceId,
                this.emailConfig.templateId,
                templateParams
            );

            console.log('âœ… Email enviado exitosamente:', result);
            return result;

        } catch (error) {
            console.error('âŒ Error enviando email:', error);
            
            // Proporcionar mensaje de error mÃ¡s especÃ­fico segÃºn el cÃ³digo
            let errorMessage = 'Error desconocido enviando email';
            
            if (error.status === 400) {
                errorMessage = 'Error en los datos del formulario';
            } else if (error.status === 401) {
                errorMessage = 'Error de autenticaciÃ³n con EmailJS';
            } else if (error.status === 403) {
                errorMessage = 'Acceso denegado a EmailJS';
            } else if (error.status >= 500) {
                errorMessage = 'Error del servidor de EmailJS';
            }

            throw new Error(errorMessage);
        }
    }

    /**
     * FORMATEO DE FECHA
     * Convierte fecha del input a formato legible en espaÃ±ol
     */
    formatDate(dateString) {
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                weekday: 'long',      // DÃ­a de la semana completo
                year: 'numeric',      // AÃ±o en nÃºmeros
                month: 'long',        // Mes completo
                day: 'numeric'        // DÃ­a del mes
            });
        } catch (error) {
            return dateString;    // Devolver original si hay error
        }
    }

    /**
     * FORMATEO DE HORA
     * Convierte hora del input a formato legible de 24 horas
     */
    formatTime(timeString) {
        try {
            const [hours, minutes] = timeString.split(':');
            const date = new Date();
            date.setHours(parseInt(hours), parseInt(minutes));
            return date.toLocaleTimeString('es-ES', {
                hour: '2-digit',      // Hora con 2 dÃ­gitos
                minute: '2-digit'     // Minutos con 2 dÃ­gitos
            });
        } catch (error) {
            return timeString;    // Devolver original si hay error
        }
    }

    /**
     * CREACIÃ“N DE MENSAJE COMPLETO
     * Genera un mensaje de texto completo con todos los detalles de la reserva
     */
    createFullMessage(data, serviceName) {
        let message = `NUEVA RESERVA DE CITA\n\n`;
        message += `Nombre: ${data.firstName} ${data.lastName}\n`;
        message += `Email: ${data.email}\n`;
        message += `TelÃ©fono: ${data.phone}\n`;
        message += `Servicio: ${serviceName}\n`;
        message += `Fecha: ${this.formatDate(data.date)}\n`;
        message += `Hora: ${this.formatTime(data.time)}\n`;
        message += `Servicio Express: ${data.priority ? 'SÃ­' : 'No'}\n`;
        message += `RecolecciÃ³n a domicilio: ${data.pickup ? 'SÃ­' : 'No'}\n`;
        
        // AÃ±adir direcciÃ³n solo si fue proporcionada
        if (data.address) {
            message += `DirecciÃ³n de recolecciÃ³n: ${data.address}\n`;
        }
        
        // AÃ±adir descripciÃ³n adicional si fue proporcionada
        if (data.description) {
            message += `\nDescripciÃ³n adicional:\n${data.description}\n`;
        }

        // AÃ±adir timestamp de cuÃ¡ndo se realizÃ³ la reserva
        message += `\n---\nReserva realizada el ${new Date().toLocaleString('es-ES')}`;
        
        return message;
    }

    /**
     * VALIDACIÃ“N DEL FORMULARIO
     * Verifica que todos los campos requeridos estÃ©n completos y sean vÃ¡lidos
     */
    validateForm(data) {
        // Lista de campos obligatorios
        const required = ['firstName', 'lastName', 'email', 'phone', 'service', 'date', 'time'];
        
        // Verificar que todos los campos requeridos estÃ©n presentes
        for (const field of required) {
            if (!data[field] || data[field].trim() === '') {
                console.error(`âŒ Campo requerido faltante: ${field}`);
                this.showErrorNotification(`El campo ${this.getFieldDisplayName(field)} es requerido`);
                return false;
            }
        }

        // Validar formato de email usando expresiÃ³n regular
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(data.email)) {
            console.error('âŒ Formato de email invÃ¡lido');
            this.showErrorNotification('Por favor ingresa un email vÃ¡lido');
            return false;
        }

        // Validar formato bÃ¡sico de telÃ©fono (nÃºmeros, espacios, guiones, parÃ©ntesis)
        const phoneRegex = /^[\d\s\-\(\)\+]+$/;
        if (!phoneRegex.test(data.phone.trim())) {
            console.error('âŒ Formato de telÃ©fono invÃ¡lido');
            this.showErrorNotification('Por favor ingresa un telÃ©fono vÃ¡lido');
            return false;
        }

        // Si requiere recolecciÃ³n, verificar que se haya proporcionado direcciÃ³n
        if (data.pickup && (!data.address || data.address.trim() === '')) {
            console.error('âŒ DirecciÃ³n requerida para recolecciÃ³n');
            this.showErrorNotification('La direcciÃ³n es requerida para el servicio de recolecciÃ³n');
            return false;
        }

        return true;  // Todas las validaciones pasaron
    }

    /**
     * OBTENER NOMBRE LEGIBLE DE CAMPO
     * Convierte nombres tÃ©cnicos de campos a nombres legibles para el usuario
     */
    getFieldDisplayName(field) {
        const fieldNames = {
            firstName: 'Nombre',
            lastName: 'Apellido', 
            email: 'Email',
            phone: 'TelÃ©fono',
            service: 'Servicio',
            date: 'Fecha',
            time: 'Hora',
            address: 'DirecciÃ³n'
        };
        return fieldNames[field] || field;
    }

    /**
     * GUARDADO LOCAL DE RESERVA
     * Guarda la reserva en localStorage del navegador como respaldo
     */
    saveBooking(data) {
        try {
            // Obtener reservas existentes
            const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
            
            // Crear objeto de reserva con metadatos
            const booking = {
                id: Date.now(),                         // ID Ãºnico basado en timestamp
                ...data,                                // Todos los datos del formulario
                status: 'pending',                      // Estado inicial
                createdAt: new Date().toISOString()     // Timestamp de creaciÃ³n
            };
            
            // AÃ±adir nueva reserva y guardar
            bookings.push(booking);
            localStorage.setItem('bookings', JSON.stringify(bookings));
            console.log('âœ… Reserva guardada localmente');
        } catch (error) {
            console.warn('âš ï¸ No se pudo guardar localmente:', error);
            // No bloquear el proceso si falla localStorage
        }
    }

    /**
     * CONTROL DE ESTADO DE CARGA
     * Cambia la apariencia del botÃ³n de envÃ­o durante el procesamiento
     */
    setLoadingState(loading) {
        const submitBtn = document.getElementById('submitBtn');
        if (!submitBtn) return;

        const btnText = submitBtn.querySelector('.btn-text');        // Texto normal
        const btnLoading = submitBtn.querySelector('.btn-loading');  // Spinner de carga

        if (loading) {
            // Mostrar estado de carga
            if (btnText) btnText.classList.add('hidden');
            if (btnLoading) btnLoading.classList.remove('hidden');
            submitBtn.disabled = true;  // Deshabilitar botÃ³n
        } else {
            // Restaurar estado normal
            if (btnText) btnText.classList.remove('hidden');
            if (btnLoading) btnLoading.classList.add('hidden');
            submitBtn.disabled = false;  // Habilitar botÃ³n
        }
    }

    /**
     * MÃ‰TODOS DE NOTIFICACIÃ“N
     * Funciones auxiliares para mostrar mensajes al usuario
     */

    /**
     * MOSTRAR NOTIFICACIÃ“N DE Ã‰XITO
     */
    showSuccessNotification(message) {
        this.showNotification(message, 'success');
    }

    /**
     * MOSTRAR NOTIFICACIÃ“N DE ERROR
     */
    showErrorNotification(message) {
        this.showNotification(message, 'error');
    }

    /**
     * MOSTRAR NOTIFICACIÃ“N GENÃ‰RICA
     * Sistema principal de notificaciones con fallback
     */
    showNotification(message, type = 'info') {
        // Usar sistema de notificaciones de la app principal si estÃ¡ disponible
        if (window.App && window.App.showNotification) {
            window.App.showNotification(message, type);
        } else {
            // Fallback: log en consola y notificaciÃ³n visual simple
            console.log(`${type.toUpperCase()}: ${message}`);
            this.createSimpleNotification(message, type);
        }
    }

    /**
     * CREAR NOTIFICACIÃ“N VISUAL SIMPLE
     * Crea una notificaciÃ³n toast bÃ¡sica si no hay sistema principal
     */
    createSimpleNotification(message, type) {
        // Crear elemento de notificaciÃ³n
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            background-color: ${type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#3b82f6'};
            transform: translateX(100%);
            transition: transform 0.3s ease;
        `;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Animar entrada (deslizar desde la derecha)
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
        }, 10);
        
        // Auto-remover despuÃ©s de un tiempo
        setTimeout(() => {
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 300);
        }, type === 'error' ? 8000 : 5000);  // Errores se muestran mÃ¡s tiempo
    }

    /**
     * MÃ‰TODOS UTILITARIOS PÃšBLICOS
     * Funciones para verificar estado y obtener datos
     */

    /**
     * VERIFICAR SI EL SISTEMA ESTÃ LISTO
     * Retorna true si BookingManager y EmailJS estÃ¡n inicializados
     */
    isReady() {
        return this.isInitialized && window.emailjs;
    }

    /**
     * OBTENER RESERVAS GUARDADAS
     * Recupera todas las reservas del almacenamiento local
     */
    getBookings() {
        try {
            return JSON.parse(localStorage.getItem('bookings') || '[]');
        } catch (error) {
            console.warn('Error reading bookings:', error);
            return [];
        }
    }
}

/**
 * INICIALIZACIÃ“N AUTOMÃTICA
 * Crea instancia de BookingManager cuando el DOM estÃ© completamente cargado
 */
document.addEventListener('DOMContentLoaded', () => {
    // Solo inicializar si existe el formulario de reservas en la pÃ¡gina
    if (document.getElementById('bookingForm')) {
        window.bookingManager = new BookingManager();
        console.log('ðŸš€ BookingManager inicializado');
    }
});

// Exportar clase para uso en mÃ³dulos
export default BookingManager;